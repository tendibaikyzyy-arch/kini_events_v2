{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>KINI √ó Yessenov ‚Äî –ö–∞–ª–µ–Ω–¥–∞—Ä—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- –æ–±—â–∏–π —Å—Ç–∏–ª—å -->
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <!-- —Å—Ç–∏–ª—å –∏–º–µ–Ω–Ω–æ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞ -->
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
</head>

<body class="dash-body">

  <div class="top">
    <img src="{% static 'img/yessenov.png' %}" alt="Yessenov">
    <img src="{% static 'img/kini.png' %}" alt="KINI">
  </div>

  <div class="container">
    <div class="sidebar">
      <a href="#" class="active" data-view="calendar">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
      <a href="#" data-view="events">üìå –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</a>
      <a href="#" data-view="my">‚≠ê –ú–æ–∏ —Å–æ–±—ã—Ç–∏—è</a>
      <a href="#" data-view="notif">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</a>

      {% if user.is_staff %}
        <a href="{% url 'reports' %}">üìä –û—Ç—á—ë—Ç—ã</a>
      {% endif %}

      <form action="{% url 'logout' %}" method="post" class="logout-form">
        {% csrf_token %}
        <button type="submit">üö™ –í—ã–π—Ç–∏</button>
      </form>
    </div>

    <div class="main">
      <!-- Django messages (–ø—Ä–µ–≤—Ä–∞—Ç–∏–º –≤ —Ç–æ—Å—Ç—ã) -->
      <div class="messages">
        {% for m in messages %}
          <div class="msg {% if m.tags == 'success' %}ok{% else %}err{% endif %}">{{ m }}</div>
        {% endfor %}
      </div>

      <section id="calendar" class="section active">
        <div id="calendarContainer"></div>
      </section>

      <section id="events" class="section">
        <h2>–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h2>
        <div id="eventList" class="cards"></div>
      </section>

      <section id="my" class="section">
        <h2>–ú–æ–∏ —Å–æ–±—ã—Ç–∏—è</h2>
        <div id="myEventList" class="cards"></div>
      </section>

      <section id="notif" class="section">
        <h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
        <div id="notifList"></div>
      </section>
    </div>
  </div>

  <!-- Toast -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- hidden POST form (CSRF) -->
  <form id="bookForm" method="POST" style="display:none;">
    {% csrf_token %}
  </form>

  <script>
    const URL_EVENTS_JSON    = "{% url 'events_json' %}";
    const URL_REMINDERS_JSON = "{% url 'reminders_json' %}";
    const URL_MY_EVENTS_JSON = "{% url 'my_events_json' %}";
    const URL_NOTIFS_JSON    = "{% url 'notifications_json' %}";
    const URL_BOOK_TEMPLATE  = "{% url 'register_for_event' 0 %}";

    function createToast(text, type){
      const box = document.getElementById('toastContainer');
      const el  = document.createElement('div');
      el.className = 'toast ' + (type === 'ok' ? 'toast-ok' : 'toast-err');
      el.textContent = text;
      box.appendChild(el);
      setTimeout(()=> el.classList.add('show'), 10);
      setTimeout(()=>{
        el.classList.remove('show');
        setTimeout(()=> el.remove(), 400);
      }, 4000);
    }
    
    function showDjangoMessagesAsToasts(){
      const msgBox = document.querySelector('.messages');
      if(!msgBox) return;
      const msgs = msgBox.querySelectorAll('.msg');
      if(!msgs.length) return;

      msgs.forEach(m=>{
        const text = m.textContent.trim();
        if(!text) return;
        const type = m.classList.contains('ok') ? 'ok' : 'err';
        createToast(text, type);
      });

      msgBox.style.display = 'none';
    }

    async function showRemindersToasts(){
  try{
    const res = await fetch(URL_REMINDERS_JSON);
    const data = await res.json();
    if(!data.length) return;

    data.forEach(r => {
      const txt = `–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ${r.title} ${r.when}` + (r.place ? ` ‚Ä¢ ${r.place}` : '');
      createToast(txt, 'ok');
    });
  }catch(e){
    // –º–æ–ª—á–∞
  }
}

    
    function updateNotifMenuBadge(count){
      const link = document.querySelector('.sidebar a[data-view="notif"]');
      if(!link) return;
      if(count > 0){
        link.textContent = `üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (${count})`;
        link.classList.add('has-new');
      }else{
        link.textContent = 'üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
        link.classList.remove('has-new');
      }
    }

    async function initNotifBadge(){
      try{
        const res  = await fetch(URL_NOTIFS_JSON);
        const data = await res.json();
        updateNotifMenuBadge(data.length);
      }catch(err){}
    }

    document.querySelectorAll(".sidebar a[data-view]").forEach(link => {
      link.onclick = e => {
        e.preventDefault();
        document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
        link.classList.add("active");
        document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
        const id = link.dataset.view;
        document.getElementById(id).classList.add("active");

        if (id === 'events') loadEvents();
        if (id === 'my')     loadMyEvents();
        if (id === 'notif')  {
          loadNotifs();
          updateNotifMenuBadge(0);
        }
      };
    });

    document.addEventListener('DOMContentLoaded', function() {
      const el = document.getElementById('calendarContainer');
      const calendar = new FullCalendar.Calendar(el, {
        initialView: 'dayGridMonth',
        locale: 'ru',
        height: 650,
        headerToolbar: {
          left:'prev,next today',
          center:'title',
          right:'dayGridMonth,timeGridWeek'
        },
        events: URL_EVENTS_JSON,
        eventClick: function(info) {
          const start = info.event.start ? info.event.start.toLocaleString() : '';
          alert('–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ: ' + info.event.title + '\n–î–∞—Ç–∞: ' + start);
        }
      });
      calendar.render();

      showDjangoMessagesAsToasts();
      initNotifBadge();
    });

    async function loadEvents(){
      const box = document.getElementById('eventList');
      box.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      try{
        const res  = await fetch(URL_EVENTS_JSON);
        const data = await res.json();
        if(!data.length){
          box.innerHTML = '<p class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.</p>';
          return;
        }
        box.innerHTML = '';
        data.forEach(e => {
          const left = Math.max((e.capacity || 0) - (e.taken || 0), 0);
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <h3>${e.title}</h3>
            <p class="muted">${e.description || ''}</p>
            <p><b>–ö–æ–≥–¥–∞:</b> ${(e.start || '').replace('T',' ')}</p>
            <p><b>–ì–¥–µ:</b> ${e.place || '‚Äî'}</p>
            <p><b>–ú–µ—Å—Ç:</b> ${e.capacity || '‚Äî'} ‚Ä¢ <b>–°–≤–æ–±–æ–¥–Ω–æ:</b> ${left}</p>
            <button class="btn" ${left<=0?'disabled':''} onclick="book(${e.id})">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
          `;
          box.appendChild(card);
        });
      }catch(err){
        box.innerHTML = '<p class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</p>';
      }
    }

    async function loadMyEvents(){
      const box = document.getElementById('myEventList');
      box.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      try{
        const res  = await fetch(URL_MY_EVENTS_JSON);
        const data = await res.json();
        if(!data.length){
          box.innerHTML = '<p class="muted">–í—ã –µ—â—ë –Ω–µ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.</p>';
          return;
        }
        box.innerHTML = '';
        data.forEach(e => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <h3>${e.title}</h3>
            <p><b>–î–∞—Ç–∞:</b> ${e.date} ${e.time || ''}</p>
            <p><b>–ú–µ—Å—Ç–æ:</b> ${e.place || '‚Äî'}</p>
            <button class="btn" onclick="leaveFeedback(${e.id})">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
          `;
          box.appendChild(card);
        });
      }catch(err){
        box.innerHTML = '<p class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</p>';
      }
    }

    function leaveFeedback(eventId){
      window.location.href = `/events/${eventId}/feedback/`;
    }

    async function loadNotifs(){
      const box = document.getElementById('notifList');
      box.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      try{
        const res  = await fetch(URL_NOTIFS_JSON);
        const data = await res.json();
        if(!data.length){
          box.innerHTML = '<p class="muted">–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.</p>';
          return;
        }
        box.innerHTML = '';
        data.forEach(n => {
          const row = document.createElement('div');
          row.className = 'card';
          row.innerHTML = `
            <b>${n.title}</b><br>
            <span class="muted">${n.created}</span>
            <p>${n.body || ''}</p>
          `;
          box.appendChild(row);
        });
      }catch(err){
        box.innerHTML = '<p class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</p>';
      }
    }

    function book(eventId){
      const form = document.getElementById('bookForm');
      form.action = URL_BOOK_TEMPLATE.replace('/0/', `/${eventId}/`);
      form.submit();
    }
  </script>

</body>
</html>
